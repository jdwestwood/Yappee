<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Force based label placement</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen">
    <script src="http://code.jquery.com/jquery.js"></script>
    <script src="/js/bootstrap.min.js"></script>
    <script src="/js/underscore.js"></script>
    <script type="text/javascript" src="http://d3js.org/d3.v3.min.js" charset="utf-8">
</script>
    <link rel="stylesheet" href="/css/jdwmainpage.css">

<!--    <style type="text/css">
      iframe {
        width: 900, height: 600;
      }
    </style>
-->
  </head>

  <body>
    <ul class="nav nav-tabs" id="topTabs">
      <li>
	<a id="patMap" href="#Map" data-toggle="tab">Map</a>
      </li>
      <li class="active">
	<a id="gAdvSearchForm" href="#Search" data-toggle="tab">Search</a>
      </li>
    </ul>

    <div class="tab-content" id="topTabsContent">
      <div class="tab-pane" id="Map">
      </div>
      <div class="tab-pane active" id="Search">
        <iframe id="gps" src="/advanced_patent_search" width="1050" height="700" scrolling="no" allowfullscreen="true" sandbox="allow-same-origin allow-top-navigation allow-forms allow-scripts">
	</iframe>
      </div>
    </div>

    <script type="text/javascript">

      $(document).ready(setupInitialTabs);

      function setupInitialTabs() {
        $("head").append($("script#customize-bootstrap-styles").html());      // append customized bootstrap styles (for tabs and popover html content)
        var aTab = $("a[data-toggle='tab']");
        aTab.on('shown.bs.tab', function(event) {                          // setup eventListeners so popovers on other tabs are disabled/reenabled correctly
          if (event.relatedTarget) {
            var $previousTab = $(event.relatedTarget);
            if ($previousTab.popover) {
              $previousTab.popover('enable');
              var tab_id = $previousTab.attr("id");
              if (tab_id.slice(0,10) == 'relatedTab') {                    // update the popover content of a related tab
                updateRelatedTabPopover($previousTab);
              }  
            }
          }
        });
      }

      function updateRelatedTabPopover($aTab) {
        // $aTab is a jQuery object containing the <a> element that is used to activate a bootstrap tab
	var divID = $aTab.attr("href");               // need to get the document in the iframe of the div element associated with this tab
	var $context = $("div"+divID+" iframe").contents();
	var searchEntries = extractPriorArtSearchEntries($context);
	var popoverObject = $aTab.data('bs.popover');                     // get reference to popover instance; the .tip() method
	var popoverObjectContent = popoverObject.options.content;         // get popover html content
	var $popoverObjectContent = $(popoverObjectContent, popoverObjectContent);    // make into a jQuery object
	var $newTDsearch = $("td#jdw-pop-search-terms", popoverObjectContent).html(searchEntries.searchTerms);
	var $newTDstartDate = $("td#jdw-pop-start-date", popoverObjectContent).html(searchEntries.startDate);
	var $newTDendDate = $("td#jdw-pop-end-date", popoverObjectContent).html(searchEntries.endDate);
	$("td#jdw-pop-search-terms", $popoverObjectContent).replaceWith($newTDsearch);
	$("td#jdw-pop-start-date", $popoverObjectContent).replaceWith($newTDstartDate);
	$("td#jdw-pop-end-date", $popoverObjectContent).replaceWith($newTDendDate);
	popoverObject.options.content = $popoverObjectContent[0].outerHTML;
      }

      function extractPriorArtSearchEntries($context) {
	// extract patent number, title, search terms, and search dates for popover
	var searchTerms = '';
	$("div.search-term-wrapper span.jfk-checkbox-checked", $context).parent().parent()
	  .each( function(index) {
	    if (index == 0) {
	        searchTerms += $(this).text().trim();
	      }
	      else {
	        searchTerms += '<br>' + $(this).text().trim();
	    }
	  });
	var startDate = $("tr#start-date input", $context).val();
	if (startDate == '') startDate = 'Any';
	var endDate = $("tr#end-date input", $context).val();
	if (endDate == '') endDate = 'Any';
	return {searchTerms: searchTerms, startDate: startDate, endDate: endDate};
      }

      function deleteTab(event) {
        var clickedButton = $(event.target);
        var assocTab = clickedButton.closest("a");             // previous sibling element of the parent
        var activeTab = $("li.active > a");
        if (activeTab.get(0) == assocTab.get(0)) {             // are the HTML elements the same (the jQuery objects are not!)
            nextTab = assocTab.parent().prev().children("a");  // the previous tab
          }
          else {
            nextTab = activeTab
        }
        nextTab.tab("show");                                 // show nextTab before deleting the clicked tab and its content so popovers behave properly
        $("div"+assocTab.attr("href")).remove();             // remove the content of the tab; (the href of the anchor starts with '#' and references the div)
        clickedButton.closest("li").remove();                // remove the list element for the tab itself
      }

    </script>

    <script type="text/javascript">

      $("iframe#gps").load(function() {
        var nSearchResultTabs = 0, nPatentTabs = 0, nRelatedTabs = 0;
        var $context = $(this).contents();
        $("a[href='http://www.google.com/'] > img", $context).unwrap();    // delete link associated with the Google logo
        $("a[href='/about.html']", $context).remove();                     // delete the 'About Google' link
        $("center:contains('\u00A9')", $context).remove();                 // delete the Google copyright notice
        $("form[action='/patents']", $context).on("submit", on_submit_form);  // intercept the form submit request...


        var patentLists = {
           "map": {},
           "favorites": {}
        };

        var external_URLs = ['worldwide.espacenet.com',
                             'register.epo.org',
                             'uspto.gov',
                             'wipo.int',
                             'scholar.google.com',
                             'docs.google.com'];

        var rExp_patno_from_url = /\/(?:patents|related)\/(\w+)(?:[\?#%&]|$)/;  // match /patent_num?,# or end of url string; (?:...) specifies non-capturing

        var formFields = {
          "as_q" : "All of: ",
          "as_epq" : "Exactly: ",
          "as_oq" : "At least one: ",
          "as_eq" : "None of: ",
          "as_pnum" : "Patent: ",
          "as_vt" : "Title: ",
          "as_pinvent" : "Inventor: ",
          "as_pasgnee" : "Assignee: ",
          "as_pusc" : "US class: ",
          "as_pintlc" : "Int'l class: ",
          "as_pcoopc" : "Coop class: ",
          "as_ptypeorstatus" : "Type: ",
          "as_drrb_is" : "ChkBoxPatDateOptions",    // value 'q' anytime; value 'b' between dates
          "as_minm_is" : "MinMonth",
          "as_miny_is" : "MinYear",
          "as_maxm_is" : "MaxMonth",
          "as_maxy_is" : "MaxYear",
          "as_pdatetype" : "Restrict by"          // value '1' application date; value '2' issue date
        };

        var typeValues = {
          "0" : "Any", "1" : "Application", "2" : "Issued", "3" : "Utility", "4" : "Design", "5" : "Plant",
          "6" : "Other", "7" : "Other", "8" : "Other"
        };

        var restrictByValues = {
          "1" : "Appl. date", "2" : "Issue date"
        };

        var monthValues = {
          "0" : "", "1" : "Jan ", "2" : "Feb ", "3" : "Mar ", "4" : "Apr ", "5" : "May ", "6" : "Jun ",
          "7" : "Jul ", "8" : "Aug ", "9" : "Sep ", "10" : "Oct ", "11" : "Nov ", "12" : "Dec "
        };

        function TableTemplateVars() {
          return {
            "t1" : "", "v1" : "",
            "t2" : "", "v2" : "",
            "t3" : "", "v3" : "",
            "t4" : "", "v4" : "",
            "t5" : "", "v5" : "",
            "t6" : "", "v6" : "",
            "t7" : "", "v7" : "",
            "t8" : "", "v8" : "",
            "t9" : "", "v9" : "",
            "t10" : "", "v10" : "",
            "t11" : "", "v11" : "",
            "t12" : "", "v12" : "",
            "t13" : "", "v13" : "",
            "t14" : "", "v14" : "",
            "t15" : "", "v15" : "",
            "t16" : "", "v16" : ""};
        }

        function on_submit_form(event) {
          event.preventDefault();
          var searchTerms = $(this).serializeArray();                           // an array of objects {name: input field name, value: input field value}
          var url = $(this).attr('action');
          var formData = $(this).serialize();                                   // get the form query data
//          $.get(url, formData, function(resp) {                               // do a GET request to do the search
          make_search_result_tab(url + '?' + formData, '', searchTerms);
        }

        function createHTMLSummaryTable(scriptName, searchTerms) {
        // populates the html template defined in scriptName with a table of searchTerms
          var tableTemplateVars = TableTemplateVars();
          var dateInfo = {};
          var inputName = '', entryName = '', entryValue = '';
          var maxChar = 25;
          var tableEntry = 0;
          searchTerms.forEach( function(inputField) {
            inputName = inputField["name"];
            if (formFields[inputName]) {                                        // there are some input fields we have not defined in formFields
              entryName = formFields[inputName];
              entryValue = inputField["value"];
              switch (entryName) {
                case "All of: ": case "Exactly: ": case "At least one: ": case "None of: ": case "Patent: ": case "Title: ": case "Inventor: ": case "Assignee: ":
                case "US class: ": case "Intl class: ": case "Coop class: ":
                  if (entryValue != "") {
                    tableEntry += 1;
                    tableTemplateVars["t"+tableEntry] = entryName;
                    tableTemplateVars["v"+tableEntry] = entryValue;           // no need to truncate long strings; CSS of the class .vcell takes care of it!
                  }
                  break;
                case "Type: ": case "ChkBoxPatDateOptions": case "MinMonth": case "MinYear": case "MaxMonth": case "MaxYear": case "Restrict by":
                  dateInfo[entryName] = entryValue;                             // need to store these values and process them separately
                  break;
              }
            };
          });

          tableEntry = 4*Math.ceil(tableEntry/4);                            // round to nearest multiple of 4
          tableEntry += 1;
          tableTemplateVars["t"+tableEntry] = "Type: ";                      // put in the last column in the table
          tableTemplateVars["v"+tableEntry] = typeValues[dateInfo["Type: "]];
          if (dateInfo["ChkBoxPatDateOptions"] == 'q') {                      // no restriction on date
            tableEntry += 1;
            tableTemplateVars["t"+tableEntry] = "Date: ";
            tableTemplateVars["v"+tableEntry] = "Any";
          }
          else {                                                                // process the date restrictions
            tableEntry += 1;
            tableTemplateVars["t"+tableEntry] = "Start date: ";
            if (dateInfo["MinYear"] == "") {
              tableTemplateVars["v"+tableEntry] = "Any";
            }
            else {
              tableTemplateVars["v"+tableEntry] = monthValues[dateInfo["MinMonth"]] + dateInfo["MinYear"];
            }
            tableEntry += 1;
            tableTemplateVars["t"+tableEntry] = "End date: ";
            if (dateInfo["MaxYear"] == "") {
              tableTemplateVars["v"+tableEntry] = "Any";
            }
            else {
              tableTemplateVars["v"+tableEntry] = monthValues[dateInfo["MaxMonth"]] + dateInfo["MaxYear"];
            }
            tableEntry += 1;
            tableTemplateVars["t"+tableEntry] = "Restrict by: ";
            tableTemplateVars["v"+tableEntry] = restrictByValues[dateInfo["Restrict by"]];
          };

          return _.template( $(scriptName).html(), tableTemplateVars);
        }

        function make_related_tab(related_url) {
          nRelatedTabs += 1;
          var link_match = rExp_patno_from_url.exec(unescape(related_url));        // javascript unescape() function to remove %2F
          var patent_no = link_match ? link_match[1] : '';
          var tab_name = 'Re-' + patent_no;
          var tab_id = "relatedTab_" + nRelatedTabs;
          var tab_content_id = "related_" + nRelatedTabs;
          var iframe_id = "gps_related_" + nRelatedTabs;
          var navTabHTML = _.template( $("script#bs_nav-tab").html(), {tab_id: tab_id, tab_content_id: tab_content_id, tab_name: tab_name});
          var tabContentHTML = _.template( $("script#bs_tab-pane").html(),
            {tab_content_id: tab_content_id, iframe_id: iframe_id, iframe_width: 1220, iframe_height: 700});
          $("div.tab-pane.active").after(tabContentHTML);
          $("ul#topTabs li.active").after(navTabHTML);
          var htmlPriorArtHeader = _.template( $("script#prior-art-table").html(), {patent_no: patent_no});
          $("iframe#" + iframe_id).load(function() {on_related_load(this, tab_id, htmlPriorArtHeader);});
          $("iframe#" + iframe_id).attr("src", related_url);
//          $("a#" + tab_id).tab("show");
//          window.scrollTo(0,0);
        }

        function make_search_result_tab(search_url, tab_title, searchTerms) {
          nSearchResultTabs += 1;
          var tab_name = (tab_title == '') ? 'S-' + nSearchResultTabs.toString() : tab_title;
          var tab_id = "searchTab_" + nSearchResultTabs;
          var tab_content_id = "result_" + nSearchResultTabs;
          var iframe_id = "gps_result_" + nSearchResultTabs;
          var navTabHTML = _.template( $("script#bs_nav-tab").html(), {tab_id: tab_id, tab_content_id: tab_content_id, tab_name: tab_name});
          var tabContentHTML = _.template( $("script#bs_tab-pane").html(),
            {tab_content_id: tab_content_id, iframe_id: iframe_id, iframe_width: 1050, iframe_height: 700});
          $("div.tab-pane.active").after(tabContentHTML);
          $("ul#topTabs li.active").after(navTabHTML);
          var htmlSearchTermsTable = createHTMLSummaryTable("script#search-term-table", searchTerms);   // table at the top of the search result page
          var htmlPopoverTable = createHTMLSummaryTable("script#search-term-popover", searchTerms);     // table in the popover for the page
          $("iframe#" + iframe_id).load(function() {on_search_result_load(this, tab_id, htmlSearchTermsTable, htmlPopoverTable);});
          $("iframe#" + iframe_id).attr("src", search_url);
//          $("a#" + tab_id).tab("show");
//          window.scrollTo(0,0);
        }

        function make_more_result_tab($currentIFrame, more_result_url) {
        // load more search results into the current iframe ($currentIFrame is a jQuery object)
          htmlSearchTermsTable = $("div#jdw1", $currentIFrame.contents()).clone();
          $currentIFrame.off("load");                                                                   // remove original search result load event handler
          $currentIFrame.on("load", function() {on_more_result_load(this, htmlSearchTermsTable);});
          $currentIFrame.attr("src", more_result_url);
          window.scrollTo(0,0);
        }

        function setupSearchTab(tab_id, htmlPopoverTable) {
          var aTab = $("a#" + tab_id);
          aTab.popover( {placement: "bottom", trigger: "hover", html: true, title: "Search:", content: htmlPopoverTable} );   // use trigger: "click" for debugging
          aTab.popover('disable');                       // disable initially since we are already looking at this tab
          var popoverObject = aTab.data('bs.popover');                                              // get reference to popover instance; the .tip() method
          $(popoverObject.tip()).addClass('jdwsearch').children("div,h3").addClass('jdwsearch');    // returns the top div element of the popover so can add my own css
          aTab.on('shown.bs.tab', on_tab_shown);
        }

        function on_tab_shown(event) {
          var $clickedTab = $(event.target);
          if ($clickedTab.data('bs.popover')) {
            $clickedTab.popover('hide');              // was already hovering before the click; make it disappear
            $clickedTab.popover('disable');           // prevent it from popping up again
          }
          if (event.relatedTarget) {
            var $previousTab = $(event.relatedTarget);
            if ($previousTab.data('bs.popover')) {
              $previousTab.popover('enable');
              var tab_id = $previousTab.attr("id");
              if (tab_id.slice(0,10) == 'relatedTab') {         // update the popover content of a related tab
                updateRelatedTabPopover($previousTab);
              }  
            }
          }
        }

        function make_patent_tab(patent_url, patent_no) {
          nPatentTabs += 1;
          var tab_id = "patTab_" + nPatentTabs;
          var tab_content_id = "patent_" + nPatentTabs;
          var iframe_id = "gps_patent_" + nPatentTabs;
          var navTabHTML = _.template( $("script#bs_nav-tab").html(), {tab_id: tab_id, tab_content_id: tab_content_id, tab_name: patent_no});
          var tabContentHTML = _.template( $("script#bs_tab-pane").html(),
            {tab_content_id: tab_content_id, iframe_id: iframe_id, iframe_width: 1050, iframe_height: 700});
          var tabButtonHTML = $("script#tab-buttons").html();
          $("div.tab-pane.active").after(tabContentHTML);
          $("ul#topTabs li.active").after(navTabHTML);
          var aTab = $("a#" + tab_id);
          aTab.append(tabButtonHTML);                          // add the map and favorite buttons
          setupMapFavButtons(aTab, document, "main", patent_no);
          $("iframe#" + iframe_id).load( function() {on_patent_load(this, tab_id);});
          $("iframe#" + iframe_id).attr("src", patent_url);
        }

        function setupMapFavButtons($btnContext, $docContext, page_type, patent_no) {
          var btnMap = $("span.btn-map-add", $btnContext);
console.log("Button setup");
console.log(btnMap);
          var btnFav = $("span.btn-favorite-add", $btnContext);
          $("span.btn-map-add, span.btn-favorite-add", $btnContext)
                   .attr("data-patent", patent_no).on("click", {$context: $docContext, page: page_type}, on_click_map_buttons);
          if (patent_no in patentLists["map"]) btnMap.addClass("show-result-btn");
          if (patent_no in patentLists["favorites"]) btnFav.addClass("show-result-btn");
        }

        function on_patent_load(iframeElement, tab_id) {
          var $context = $(iframeElement).contents();
          $("head", $context).append($("script#search-term-table-style").html());    // append the style for the replacement page header
          $("div#pocs", $context).remove();
          process_links($context, "patent");
          process_patent_button_bar($context);
          var patent_no = $("ul#topTabs li.active", $context).text();
          $("a[href='/patents']", $context).remove();        // Link to basic patent search
          $("div#footer_table", $context).remove();          // Links at the bottom of the page
          $("div#gb", $context).replaceWith($("script#page-header").html()); 
          $("div.viewport-chrome-toolbar div:contains('Application')", $context)
            .each( function(index) {$(this).on("click", {index: index}, on_click_Application);} );  // Application button(s)
          $("div.viewport-chrome-toolbar div:contains('Grant')", $context)
            .each( function(index) {$(this).on("click", {index: index}, on_click_Grant);} );        // Grant button
          $("span.notice-section > a", $context)             // Override default event handler assigned in process_links
            .off("click", on_click_new_patent_url).on("click", on_click_AlsoPublishedAs);
          $("td.patent-bibdata-heading:contains('Also published as') ~ td span.patent-bibdata-value > a", $context)
            .off("click", on_click_new_patent_url).on("click", on_click_AlsoPublishedAs);
          setupPatentTab(tab_id, $context);
          $("a#" + tab_id).tab("show");
          window.scrollTo(0,0);
        }

        function on_related_load(iframeElement, tab_id, htmlPriorArtHeader) {
          var $context = $(iframeElement).contents();
          $("head", $context).append($("script#search-term-table-style").html());    // append the style for the replacement page header
          // the main prior art patent list and parent patent info is loaded via javascript after the rest of the page loads; we need to detect
          // when those parts are populated with content; a hack to do this is to attach an animation to the div.r elements via css
          // see http://stackoverflow.com/questions/6997826/alternative-to-domnodeinserted
          $("body", $context).addClass("make-invisible");          // so user does not see the web page manipulations
          $("td.content-td",$context)
            .on('webkitAnimationStart', "div.r", function() {on_divr_added(this, $context);}); // Chrome animation event
          $("td.content-td",$context)
            .on('animationstart', "div.r", function() {on_divr_added(this, $context);});       // Firefox animation event
          $("td.metadata-td",$context)
            .on('webkitAnimationStart', "div.metadata", function() {on_divmeta_added(this, tab_id, $context);}); // Chrome animation event
          $("td.metadata-td",$context)
            .on('animationstart', "div.metadata", function() {on_divmeta_added(this, tab_id, $context);});       // Firefox animation event
          process_links($context, "related");

          // generate click for prior art patents only
          var patentsOnlyOption = $("div#left-toolbar-buttons div:contains('Patents')", $context).get(0);   // get underlying Element of Patents nav option
          simulateClick(patentsOnlyOption, 'mousedown', patentsOnlyOption.ownerDocument.defaultView);                    // so can send mousedown, mouseup event
          simulateClick(patentsOnlyOption, 'mouseup', patentsOnlyOption.ownerDocument.defaultView);
          $("div#pocs", $context).remove();
          $("div.kd-appbar", $context).remove();                   // Prior Art Finder options row
          $("div#footer", $context).remove();
          $("div#gb", $context).replaceWith($("script#page-header").html());       // replace the google content with a greatly simplified version
          $("div#jdwTop", $context).append(htmlPriorArtHeader);                    // append html for the prior art page header
          var aTab = $("a#" + tab_id);                                          // attach on_tab_shown hander here. Firefox does not start animations until the page is visible
          aTab.on('shown.bs.tab', on_tab_shown);                                // Chrome starts them when the HTML for the animated element is loaded
          aTab.tab("show")                                                     // note that the div.r's and divmeta have not finished loading yet
          window.scrollTo(0,0);
        }

        function on_divr_added(divr, $context) {
        // called for each div.r that is added
          var divrContext = $(divr, $context);
          process_links(divrContext, "related");
          var $span_t = $("span.t", divrContext)
          if ($("span", $span_t).length == 1) {                                  // if the 'map' and 'favorites' buttons have not been added
            $("span.hide-result-btn", $span_t).addClass("btn-original");
            $span_t.append($("script#related-art-page-button-content").html());  // add them
            var btnMap = $("span.btn-map-add", $span_t);
            var patent_no = getPatentURL_No(btnMap, $context, "related").patent_no;
            setupMapFavButtons($span_t, $context, "related", patent_no);
            $("span.btn-original", $span_t).attr("title", "Hide");
          }
        }

        function setupPatentTab(tab_id, $context) {
          var bibObj = parseBiblioData($context, {});                                               // object containing bibliographic data for the patent
          inventors = bibObj.inventors.replace(/, /g, '<br/>');
          assignee = bibObj.assignee.replace(/, /g, '<br/>');
          var htmlPopoverContent = _.template( $("script#patent-info-popover").html(), {inventors: inventors, assignee: assignee} );
          var aTab = $("a#" + tab_id);
          aTab.popover( {placement: "bottom", trigger: "hover", html: true, title: bibObj.title, content: htmlPopoverContent} );  // or "click" to debug
          aTab.popover('disable');                                                                  // disable initially since we are already looking at this tab
          var popoverObject = aTab.data('bs.popover');                                              // get reference to popover instance; the .tip() method
          $(popoverObject.tip()).addClass('jdwpatent').children("div,h3").addClass('jdwpatent');    // returns the top div element of the popover so can add my own css
          aTab.on('shown.bs.tab', on_tab_shown);
        }

        function setupPriorArtTab(tab_id, $context) {
          var patent_no = $("div#patent-metadata-box h2 a", $context).text();
          var patent_title = $("div#patent-metadata-box div#title", $context).text();
          var searchEntries = extractPriorArtSearchEntries($context);
          var htmlPopoverTitle = _.template( $("script#prior-art-popover-title").html(),
            {patent_no: patent_no, patent_title: patent_title});
          var htmlPopoverContent = _.template( $("script#prior-art-popover-content").html(),
            {searchTerms: searchEntries.searchTerms, startDate: searchEntries.startDate, endDate: searchEntries.endDate});
          var aTab = $("a#" + tab_id);
          aTab.popover( {placement: "bottom", trigger: "hover", html: true, title: htmlPopoverTitle, content: htmlPopoverContent} );  // or "click" and 'enable' to debug
          aTab.popover('disable');                       // disable initially since we are already looking at this tab
          var popoverObject = aTab.data('bs.popover');                                              // get reference to popover instance; the .tip() method
          $(popoverObject.tip()).addClass('jdwprior').children("div,h3").addClass('jdwprior');    // returns the top div element of the popover so can add my own css
        }

        function on_divmeta_added(divmeta, tab_id, $context) {
          // the divmeta div; the page_type is 'related-root' - the root patent of the prior art search
          var $divmetaContext = $(divmeta, $context);
          process_links($divmetaContext, "related-root");
          $("div#discuss-this-parent", $context).remove();    // the 'Discuss the patent' button ('patent' misspelled as 'parent' in the div id!)
          $("div.metadata h2", $context).append($("script#related-art-page-button-content").html());
          var btnMap = $("div.metadata span.btn-map-add", $context);
          patent_no = getPatentURL_No(btnMap, $context, "related-root").patent_no;
          setupMapFavButtons($divmetaContext, $context, "related-root", patent_no);
          setupPriorArtTab(tab_id, $context);                 // set up the popover for the tab for this page
          $("body", $context).removeClass("make-invisible");
          $("a#" + tab_id).click();
        }

        function simulateClick(element, eventType, contextWindow) {
        // similate a mouse event 'type' on the 'element' in the 'contextWindow'
          var event = new MouseEvent(eventType, {
            'view': contextWindow,
            'bubbles': true,
            'cancelable': true
          });
          var canceled = !element.dispatchEvent(event);
          if (canceled) {
          // A handler called preventDefault.
          }
          else {
          // None of the handlers called preventDefault.
          }
        }

        function process_search_result_contents($context, htmlSearchTermsTable) {
        // process the content of a search page
          $("div#pocs", $context).remove();
          $("div#main div#top_nav", $context).remove();
          $("div#main div#topabar", $context).remove();
          $("p#bfl", $context).parent().remove();                      // Page bottom: advanced search and other links
          $("div#gfn", $context).remove();                             // Page bottom: empty div
          $("div#fll", $context).remove();                             // Page bottom: Google home and other links
          $("div#footcnt", $context).remove();                         // Page bottom: Help Feedback Privacy
          // contents() gets both text nodes and elements; remove the hyphen and the 'Discuss' link
          $("div.osl", $context).each ( function() { $(this).contents().slice(-2).remove();} );
          $("head", $context).append($("script#search-term-table-style").html());    // append the style for the replacement page header
          $("div#mngb", $context).replaceWith($("script#page-header").html()); 
          $("div#jdwTop", $context).append(htmlSearchTermsTable);  // append html for the search term table
          $("body", $context).append($("script#search-page-more-results-style").html());  // append the style for the Goooogle page links
          $("div#ires h3.r", $context).append($("script#search-page-button-content").html());  // buttons to map, add to favorites, or hide patent
          $("li.g span.btn-hide-add", $context).on("click", function(event) {on_click_hide_button(event, $context); });
          $("li.g span.btn-map-add", $context)
              .each(function() {
                 var patent_no = getPatentURL_No(this, $context, "search").patent_no;
                 $(this).attr("data-patent", patent_no).on("click", {$context: $context, page: "search"}, on_click_map_buttons);
                 if (patent_no in patentLists["map"]) $(this).addClass("show-result-btn");
               });
          $("li.g span.btn-favorite-add", $context)
              .each(function() {
                 var patent_no = getPatentURL_No(this, $context, "search").patent_no;
                 $(this).attr("data-patent", patent_no).on("click", {$context: $context, page: "search"}, on_click_map_buttons);
                 if (patent_no in patentLists["favorites"]) $(this).addClass("show-result-btn");
               });
          $("div#res", $context).before($("script#search-page-unhide-results").html()); // html to unhide hidden results
          $("span.hidden-results-message", $context).data("nHidden", 0);
          $("span.hidden-results-clear-btn", $context).on("click", function(event) {on_click_show_hidden(event, $context); });
        }

        function on_click_show_hidden(event, $context) {
        // click event handler for the 'Show all' button on the search results page that unhides hidden results
          $(event.target, $context).parent().addClass("hidden-show-all");        // the containing div element for the 'Show all' button
          $("li.hide-result", $context).removeClass("hide-result");
          $("span.hidden-results-message", $context).data('nHidden', 0);
        }

        function on_click_hide_button(event, $context) {
        // click event handler for the 'hide' button on the search results page
          var pressedButton = $(event.target, $context);
          var assocResult = pressedButton.closest("li.g", $context);
          assocResult.addClass("hide-result");
          var $hiddenMessage = $("span.hidden-results-message", $context);
          var curCount = $hiddenMessage.data("nHidden") + 1;
          $hiddenMessage.data("nHidden", curCount);                           // update the count of hidden patent results
          if (curCount == 1) {
            $hiddenMessage.text(curCount.toString() + ' result hidden below.');
          }
          else {
            $hiddenMessage.text(curCount.toString() + ' results hidden below.');
          }
          $("div.hidden-results-info", $context).removeClass("hidden-show-all")
        }

        function getPatentURL_No(element, $context, page_type) {
          // get the patent url and number associated with an HTML element or jQuery object for the element on a page of type
          // page_type ("search", "patent", or "related")
          var patent_no = '';
          var patent_url = '';
          switch (page_type) {
            case "main":
              patent_no = $(element, $context).closest("a").children("span").text(); // the text of the span element inside the anchor element for the tab
              patent_url = "/patents/" + patent_no;
              break;
            case "patent":
              patent_url = $(element, $context).attr("href");
              var link_match = rExp_patno_from_url.exec(patent_url);
              patent_no = link_match ? link_match[1] : '';
              break;
            case "search":
              var li_g = $(element, $context).closest("li.g", $context);
              patent_url = $(li_g, $context).find("cite.vurls", $context).text().replace(/www.google.com/,'');
              var link_match = rExp_patno_from_url.exec(patent_url);
              patent_no = link_match ? link_match[1] : '';
              break;
            case "related":
              var div_r = $(element, $context).closest("div.r", $context);
              patent_url = $(div_r, $context).find("cite", $context).text().replace(/www.google.com/,'');
              var link_match = rExp_patno_from_url.exec(patent_url);
              patent_no = link_match ? link_match[1] : '';
              break;
            case "related-root":
              var $div_metadata = $(element, $context).closest("div.metadata", $context);
              patent_url = $div_metadata.find("a", $context).attr("href").replace(/www.google.com/,'');
              var link_match = rExp_patno_from_url.exec(patent_url);
              patent_no = link_match ? link_match[1] : '';
            default:
          }
          return {"patent_url": patent_url, "patent_no": patent_no};
        }

        function toggleBtn(patent_no, btn, action) {
          var btn_type = btn.hasClass("btn-map-add") ? "btn-map-add": (btn.hasClass("btn-favorite-add") ? "btn-favorite-add": "");
          var $patTabBtns = $("ul.nav-tabs span."+btn_type+"[data-patent='"+patent_no+"']", document);
          if ($patTabBtns.length > 0) changeClass($patTabBtns, action);
          $("div.tab-pane[id^='result'] iframe, div.tab-pane[id^='related'] iframe")
            .each(function() {
              $context = $(this).contents();
              var $btn_family = $("span."+btn_type+"[data-patent='"+patent_no+"']", $context);
              if ($btn_family.length > 0) changeClass($btn_family, action);
            });
          function changeClass($btns, action) {
            switch (action) {
              case "remove":
                $btns.removeClass("show-result-btn");
                break;
              case "add":
                $btns.addClass("show-result-btn");
                break;
              default:
            }
          }          
        }

        function on_click_map_buttons(event) {
        // click event handler for the 'map' and 'favorite' buttons
        // event.data stores the jQuery context of the element that generated the event in .$context, and the type of page the button in .page
        // on a patent page, $context is the main html document
        // on the search results and related patents pages, $context is the document in the iframe
          event.preventDefault();
          event.stopPropagation();
          var $context = event.data.$context;
          var pressedButton = $(event.target, $context);
          var patent_info = getPatentURL_No(event.currentTarget, event.data.$context, event.data.page);
          var patent_url = patent_info.patent_url;
          var patent_no = patent_info.patent_no;
          var patList = pressedButton.hasClass("btn-map-add") ? "map": (pressedButton.hasClass("btn-favorite-add") ? "favorites": "");
          if (pressedButton.hasClass("show-result-btn")) {    // remove patent
            toggleBtn(patent_no, pressedButton, "remove");
            delete patentLists[patList][patent_no];
console.log("Remove");
console.log(patentLists);
          }
          else {                                              // add patent
            toggleBtn(patent_no, pressedButton, "add");
            if (!checkOtherLists(patList, patent_no)) {
              switch (event.data.page) {
                case "main":
                  var div_id = $(event.currentTarget, $context).closest("a").attr("href");   // the href of the anchor element for the tab
                  var patent_contents = $("div" + div_id + " > iframe", $context).contents();
                  processPat(patList, patent_contents, patent_no);                          // parse the patent page if + button clicked on patent page
                  break;
                case "search": case "related": case "related-root":
                  $.get(patent_url, function(doc) {processPat(patList, doc, patent_no);});  // get and parse the patent page if + button clicked on search or related page
                  break;
                default:
              }
            }
          }
        }

        function checkOtherLists(patList, patent_no) {
          // check if any list in patentLists other that list patList contains the patent patent_no;
          // if so add the patent_no and associated bibliographic information to patList
          for (pList in patentLists) {
            if (patent_no in patentLists[pList] & pList != patList) {
              patentLists[patList][patent_no] = patentLists[pList][patent_no];
              return true;
            }
          }
          return false;
console.log("In checkOtherLists");
console.log(patentLists);
        }

        function processPat(patList, doc, patent_no) {
          // for patent patent_no, extract the bibliographic info from the Google patent page document
          // object doc and add an entry to the patList patent list in the patentLists object
          var biblioData = parsePatentPage(doc);                 // extract bibliographic data from the patent document as an object
          patentLists[patList][patent_no] = biblioData;          // add it to the patList patent list
          switch (patentLists) {
            case "map":                                          // do the mapping on the Map tab
              break;
            case "favorites":                                     // update the Favorites list on the Map tab
              break;
            default:
          }
console.log("In processPat");
console.log(patentLists);
        }

        function parseBiblioData(doc, bibObj) {
          // doc is the document for a Google patent page; parse it for title, inventors, assignee,
          // filing date, and pubication date; add the bibliographic data to bibObj and return bibObj.
          var title = $("invention-title", doc).text();
          var inventors = "";
          var assignee = "";
          $("table.patent-bibdata td.patent-bibdata-heading:contains('Inventors') + td span.patent-bibdata-value", doc)
              .each(function() {inventors += $(this).text();});
          $("table.patent-bibdata td.patent-bibdata-heading:contains('Assignee') + td span.patent-bibdata-value", doc)
              .each(function() {assignee += $(this).text();});
          var file_date = $("table.patent-bibdata td.patent-bibdata-heading:contains('Filing date') + td.single-patent-bibdata", doc).text();
          var pub_date = $("table.patent-bibdata td.patent-bibdata-heading:contains('Publication date') + td.single-patent-bibdata", doc).text();
          bibObj["title"] = title;
          bibObj["inventors"] = inventors;
          bibObj["assignee"] = assignee;
          bibObj["file_date"] = file_date;
          bibObj["pub_date"] = pub_date;
          return bibObj;
        }

        function parseCitationData(doc, bibObj) {
          // doc is the document for a Google patent page; parse it for cited patents, and citing patents;
          // add the bibliographic data to bibObj and return bibObj.
          var cited_patents = [];
          var citing_patents = [];
          $("a#backward-citations ~ table.patent-data-table td.citation-patent a", doc)
                .each(function() {cited_patents.push(formatPatentNumber($(this).text()));});
          $("a#forward-citations ~ table.patent-data-table td.citation-patent a", doc)
                .each(function() {makeEPOQueryList(this, citing_patents);});
          bibObj["cited_patents"] = cited_patents;
          bibObj["citing-patents"] = citing_patents;
          return bibObj;
        }

        function parsePatentPage(doc) {
          // doc is the document for a Google patent page; parse it for title, inventors, assignee, cited patents, and citing patents;
          // return an object of key-value pairs.
          var bibObj = parseBiblioData(doc, {});
          bibObj = parseCitationData(doc, bibObj);
          return bibObj;
        }

        function makeEPOQueryList(citation_elem, list) {
          var patent_no = $(citation_elem).text();
          if (patent_no) {
            var EPO_patent_no = formatPatentNumber(patent_no);
            if (EPO_patent_no) {
              list.push(EPO_patent_no);
            }
          }
        }

        function formatPatentNumber(patent_no) {
          // patent_no is a patent number as it appears in the cited patents sections on the Google patent page.
          // It is a string with the country code, publication number, and kind and no spaces in between.
          // Returns a document ID string suitable for the EPO API.
          rExp_EPO_docid_from_Google_patent_no = /([A-Z]{2})(\d+)([A-Z]*\d*)/;
          var match = rExp_EPO_docid_from_Google_patent_no.exec(patent_no);
          if (match) {
            var cc = match[1];
            var pub_no = match[2];
            var kind = match[3];
            if (cc == "US" & pub_no.length == 11 & pub_no[4] == "0") { // EPO API removes the leading zero of a US application publication
              pub_no = pub_no.slice(0,4) + pub_no.slice(5,11);
            }
            return cc + pub_no + (kind ? "." + kind : "");
          }
          else {
            console.log("In formatPatentNumber, could not match '" + patent_no + "'. Skipping...");
            return '';
          }
        }

        function on_search_result_load(iframeElement, tab_id, htmlSearchTermsTable, htmlPopoverTable) {
          var $context = $(iframeElement).contents();
          process_links($context, "search");       // make google links point to my server
          process_search_result_contents($context, htmlSearchTermsTable);  // set up the search terms summary at the top of the page
          setupSearchTab(tab_id, htmlPopoverTable);            // set up the popover for the tab for this page
          $("a#" + tab_id).tab("show");
          window.scrollTo(0,0);
        }

        function on_more_result_load(iframeElement, htmlSearchTermsTable) {
          var $context = $(iframeElement).contents();
          process_links($context, "search");
          process_search_result_contents($context, htmlSearchTermsTable);
          // htmlSearchTermsTable has been cloned from the original search page; popover has already been attached to the tab
        }

        function process_links($context, page_type) {
          $("a", $context).each(function() {                   // for each link on the page
            var orig_url = $(this).attr("href");
            if (orig_url) {
              if (external_URLs.some( function(external_URL) {return orig_url.search(external_URL) >= 0 ? true : false;})) {
                $(this).on("click", on_click_external);                // open these links in a new browser tab
              }
              else {
                var strip_url = orig_url.replace('https', 'http');
                strip_url = strip_url.replace('http://www.google.com', '');  // open these links as relative to my site
                $(this).attr("href", strip_url);
                var rExp = /\/[^\?/]*[\?/]/;
                var link_match = rExp.exec(strip_url);
                var link_type = (link_match) ? link_match[0] : '';
                switch (link_type) {
                  case "/patents/":
                    $(this).removeAttr("onmousedown");
                    if (strip_url.search('/patents/related') >= 0) {
                      $(this).on("click", on_click_new_related_url);          // when search page loads, 'related' url starts with /patents/related
                    }
                    else {
                      $(this).on("click", {$context: $context, page: page_type}, on_click_new_patent_url); // patent link on search or patent page
                    }
                    break;
                  case "/search?":
                    if (strip_url.search('&start=') >= 0) {
                      $(this).on("click", on_click_more_search_result);   // more search results from the same page; do not open a new tab
                    }
                    else {
                      $(this).on("click", on_click_new_search_url);           // search link on a search page or a patent page; open a new tab
                    }
                    break;
                  case "/url?":
                    if (strip_url.search('/www.google.com/patents/') >= 0) {
                      $(this).on("click", {$context: $context, page: page_type}, on_click_new_patent_url); // patent link on prior art page;
                    }                                                                                                       // fetches patent as query after /url?
                    else {                                                    // this branch should never be called since the 'related' link on a search page
                      $(this).on("click", on_click_new_related_url);          // is processed when the page loads; after mousedown, url changes, starts with /url?
                    }
                    break;
                  default:
                  // there are other types of links as well which are not visible on the page
                }
              }
            };
          });
        }

        function on_click_new_related_url(event) {
          event.preventDefault();
          event.stopPropagation();
          var related_url = $(this).attr("href");
          make_related_tab(related_url);
        }

        function on_click_new_patent_url(event) {
          // patent url's can be clicked on search, related (as a related patent or as the root patent), or patent pages
          // event.data.$context stores the jQuery context of the element that triggered the event
          // event.data.page stores the type of page the link was clicked on
          event.preventDefault();
          event.stopPropagation();
          var patent_info = getPatentURL_No(event.currentTarget, event.data.$context, event.data.page);
          make_patent_tab(patent_info.patent_url, patent_info.patent_no);
        }

        function on_click_AlsoPublishedAs(event) {
          var $context = $(this.ownerDocument.body);
          var grant_url = $(this).attr("href");
          var link_match = rExp_patno_from_url.exec(grant_url);
          var grant_no = link_match ? link_match[1] : '';
          // if patent will open in separate browser tab, change the caption of the current application tab
          if (!external_URLs.some( function(external_URL) {return grant_url.search(external_URL) >= 0 ? true : false;})) {  
            $("ul#topTabs li.active > a").text(grant_no);
          }
          window.scrollTo(0,0);
        }

        function on_click_more_search_result(event) {
          event.preventDefault();
          event.stopPropagation();
          var $currentIFrame = $("div.tab-pane.active iframe");                 // jQuery object - the containing iframe
          var more_results_url = $(this).attr("href");
          make_more_result_tab($currentIFrame, more_results_url);
        }

        function on_click_new_search_url(event) {
          event.preventDefault();
          event.stopPropagation();
          var search_url = $(this).attr("href");
          var link_text = $(this).text();
          var tab_title = 'Result';
          var searchTerms = [{}, {"name" : "as_drrb_is", "value": "q"}, {"name": "as_ptypeorstatus", "value": "0"}]; // mimic google patent search form input fields
          if (search_url.search('ininventor') >= 0) {
            tab_title = link_text.lastIndexOf(' ') > 0 ? link_text.slice(link_text.lastIndexOf(' ') + 1) : link_text;
            searchTerms[0] = {"name": "as_pinvent", "value": link_text};
          }
          else if (search_url.search('inassignee') >=0) {
            tab_title = link_text.indexOf(' ') > 0 ? link_text.slice(0, link_text.indexOf(' ')) + '...' : link_text;
            searchTerms[0] = {"name": "as_pasgnee", "value": link_text};
          }
          else {
            console.log('Did not match search url in on_click_new_search_url');
          }
          make_search_result_tab(search_url, tab_title, searchTerms);
        }

        function process_patent_button_bar($context) {
          $("div.goog-inline-block.jfk-button", $context).each(function() {
            var button_text = $(this).text();
            // Remove any language translation buttons, 'Discuss this patent'
            if (button_text != 'Application' && button_text != 'Grant' && button_text != 'Find prior art'
              && button_text != 'View PDF' && button_text != 'Download PDF') $(this).remove();
          });
          $("div[role='button'] img[src*='settings.png']", $context).parent().parent().remove();  // gearbox settings button
          var origLeftToolbarButtons = $("div#left-toolbar-buttons", $context);
          var origRightToolbar = $("div#right-toolbar-buttons div.viewport-chrome-toolbar", $context);
          // replace divs with themselves as the only way to remove anonymous mousedown and mouseup event listeners;
          // clone('false') = do not clone event listeners;
          origRightToolbar.replaceWith(origRightToolbar.clone('false'));
          var newRightToolbar = $("div#right-toolbar-buttons div.viewport-chrome-toolbar", $context);
          newRightToolbar.on('mousedown', divMouseDown);
          newRightToolbar.on('click', on_click_patent_div_button);
        }

        function on_click_patent_div_button(event) {
          switch ($(event.target).text()) {
            case "Find prior art":
              var related_url = $("a#appbar-patents-prior-art-finder-link", $(event.target.ownerDocument)).attr("href");
              make_related_tab(related_url);
              break;
            case "View PDF":
              var external_url = $("a#appbar-read-patent-link", $(event.target.ownerDocument)).attr("href");
              window.open(external_url);
              break;
            case "Download PDF":
              var external_url = $("a#appbar-download-pdf-link", $(event.target.ownerDocument)).attr("href");
              window.open(external_url);
              break;
            default:
          }
        }

        function divMouseDown(event) {
          event.preventDefault();
//          event.stopPropagation();
        }

        function on_click_Application(event) {
          var $context = $(this.ownerDocument);
          var thisIndex = event.data.index;                       // index of element the triggered the event
          var application_url = $("a[data-label='Application']", $context).eq(thisIndex).attr("href");
          var link_match = rExp_patno_from_url.exec(application_url);
          var application_no = link_match ? link_match[1] : '';
          $("ul#topTabs li.active > a").text(application_no);     // note we are not changing the id of the tab
          window.scrollTo(0,0);
        }

        function on_click_Grant(event) {
          var $context = $(this.ownerDocument);
          var thisIndex = event.data.index;
          var grant_url = $("a[data-label='Grant']", $context).eq(thisIndex).attr("href");
          var link_match = rExp_patno_from_url.exec(grant_url);
          var grant_no = link_match ? link_match[1] : '';
          $("ul#topTabs li.active > a").text(grant_no);     // note we are not changing the id of the tab
          window.scrollTo(0,0);
        }

        function on_click_external(event) {
          event.preventDefault();
          event.stopPropagation();
          var external_url = $(this).attr("href");
          window.open(external_url);
        }
      });

    </script>

    <script id="customize-bootstrap-styles" type="text/template">    <!-- will load in main window -->
      <!-- import style for popovers on search, patent, and prior art pages -->
      <style type="text/css">
        @import url("/css/jdwpopovers.css");
        @import url("/css/jdwbuttons.css");
      </style>
    </script>

    <!-- html for adding the '+' and 'heart' (add and favorite) buttons to the Google related art page
         piggy back off of the Google css class 'hide-result-btn' for the 'x' that hides a patent;
         edit the /patents/related/static/icons.png file and add +' and 'heart' icons; (this file has many icons);
         save as iconsJDW and serve from the /css directory on my server; we select which icon to use by setting
         the position, height, and width of the background css parameter. -->
    <script id="related-art-page-button-content" type="text/template">
      <span class="hide-result-btn btn-favorite-add" title="Add to favorites"></span>
      <span class="hide-result-btn btn-map-add" title="Add to patent map"></span>
    </script>

    <script id="search-page-button-content" type="text/template">
      <span class="hide-result-btn btn-hide-add" title="Hide"></span>
      <span class="hide-result-btn btn-favorite-add" title="Add to favorites"></span>
      <span class="hide-result-btn btn-map-add" title="Add to patent map"></span>
    </script>

    <script id="search-page-unhide-results" type="text/template">
      <div class="hidden-results-info hidden-show-all">
        <span class="hidden-results-message">0 result hidden below.</span>
        <span class="hidden-results-clear-btn">Show all</span>
      </div>
    </script>

    <script id="prior-art-popover-title" type="text/template">
      Prior art for <%= patent_no %>:<br><span class="popover-subtitle jdwprior"><%= patent_title %></span>
    </script>

    <script id="prior-art-popover-content" type="text/template">
      <table id="jdw20">
        <tbody id="jdw21">
          <tr>
            <td class="jdw22">Search terms:</td>
            <td class="jdw23" id="jdw-pop-search-terms"><%= searchTerms %></td>
          </tr>
          <tr>
            <td class="jdw22">Start date:</td>
            <td class="jdw23" id="jdw-pop-start-date"><%= startDate %></td>
          </tr>
          <tr>
            <td class="jdw22">End date:</td>
            <td class="jdw23" id="jdw-pop-end-date"><%= endDate %></td>
          </tr>
        </tbody>
      </table>
    </script>

    <script id="patent-info-popover" type="text/template">
      <table id="jdw20">
        <tbody id="jdw21">
          <tr>
            <td class="jdw22">Inventors:</td>
            <td class="jdw23"><%= inventors %></td>
          </tr>
          <tr>
            <td class="jdw22">Assignee:</td>
            <td class="jdw23"><%= assignee %></td>
          </tr>
        </tbody>
      </table>
    </script>
    
    <script id="search-term-popover" type="text/template">            <!-- will load in main window -->
      <table id="jdw14">
        <tbody>
          <tr>
            <td class="tcell"><%= t1 %></td>
            <td class="vcell"><%= v1 %></td>
            <td class="tcell"><%= t5 %></td>
            <td class="vcell"><%= v5 %></td>
            <td class="tcell"><%= t9 %></td>
            <td class="vcell"><%= v9 %></td>
            <td class="tcell"><%= t13 %></td>
            <td class="vcell"><%= v13 %></td>
          </tr>
          <tr>
            <td class="tcell"><%= t2 %></td>
            <td class="vcell"><%= v2 %></td>
            <td class="tcell"><%= t6 %></td>
            <td class="vcell"><%= v6 %></td>
            <td class="tcell"><%= t10 %></td>
            <td class="vcell"><%= v10 %></td>
            <td class="tcell"><%= t14 %></td>
            <td class="vcell"><%= v14 %></td>
          </tr>
          <tr>
            <td class="tcell"><%= t3 %></td>
            <td class="vcell"><%= v3 %></td>
            <td class="tcell"><%= t7 %></td>
            <td class="vcell"><%= v7 %></td>
            <td class="tcell"><%= t11 %></td>
            <td class="vcell"><%= v11 %></td>
            <td class="tcell"><%= t15 %></td>
            <td class="vcell"><%= v15 %></td>
          </tr>
          <tr>
            <td class="tcell"><%= t4 %></td>
            <td class="vcell"><%= v4 %></td>
            <td class="tcell"><%= t8 %></td>
            <td class="vcell"><%= v8 %></td>
            <td class="tcell"><%= t12 %></td>
            <td class="vcell"><%= v12 %></td>
            <td class="tcell"><%= t16 %></td>
            <td class="vcell"><%= v16 %></td>
          </tr>
        </tbody>
      </table>
    </script>

    <!-- tweek formating of Gooooogle span so it disappears.  Will load in iframe of search pages -->
    <script id="search-page-more-results-style" type="text/template">
      <style type="text/css">
        @import url("/css/jdwsearchresultpage.css");
      </style>
    </script>

    <script id="search-term-table-style" type="text/template">    <!-- loads in iframe of search, patent and prior art pages -->

      <!-- import styles for:
             inserted Map and Favorites buttons
             customized page header
             animation trick to get the prior art div.r's to load properly -->
      <style type="text/css">
        @import url("/css/jdwbuttons.css");
        @import url("/css/jdwpageheader.css");
        @import url("/css/jdwpriorartpage.css");
      </style>
    </script>

    <!-- replacement header for google search and patent pages -->
    <script id="page-header" type="text/template">
      <div id="jdwTop">
        <div class="gb_ba gb_f jdwGoog" id="gbq1" style="max-width:127px;min-width:127px">
          <div class="gb_ca">
            <!-- replace the <a> tag in the Google page with a span having the same classes -->
            <!-- get google logo with this span -->
            <span class="gb_fb gb_ea">
              <span class="gb_c"></span>
            </span>
          </div>
        </div>
      </div>
    </script>

    <!-- header for prior art page -->
    <script id="prior-art-table" type="text/template">                  <!-- will load in prior art iframe -->
      <div id="jdw30" class="gbt">
        <h2 id="jdw31">Prior art for <%= patent_no %></h2>
      </div>
    </script>

    <!-- search term table -->
    <script id="search-term-table" type="text/template">                <!-- will load in iframe -->
      <div id="jdw1" class="gbt">
        <div id="jdw2" class="gbt">
          <table>
            <tbody>
              <tr>
                <td><b>Search terms:</b></td>
              </tr>
            </tbody>
          </table>
        </div>
        <div id="jdw3" class="gbt">
          <table id="jdw4">
            <tbody>
              <tr>
                <td class="tcell"><%= t1 %></td>
                <td class="vcell"><%= v1 %></td>
                <td class="tcell"><%= t5 %></td>
                <td class="vcell"><%= v5 %></td>
                <td class="tcell"><%= t9 %></td>
                <td class="vcell"><%= v9 %></td>
                <td class="tcell"><%= t13 %></td>
                <td class="vcell"><%= v13 %></td>
              </tr>
              <tr>
                <td class="tcell"><%= t2 %></td>
                <td class="vcell"><%= v2 %></td>
                <td class="tcell"><%= t6 %></td>
                <td class="vcell"><%= v6 %></td>
                <td class="tcell"><%= t10 %></td>
                <td class="vcell"><%= v10 %></td>
                <td class="tcell"><%= t14 %></td>
                <td class="vcell"><%= v14 %></td>
              </tr>
              <tr>
                <td class="tcell"><%= t3 %></td>
                <td class="vcell"><%= v3 %></td>
                <td class="tcell"><%= t7 %></td>
                <td class="vcell"><%= v7 %></td>
                <td class="tcell"><%= t11 %></td>
                <td class="vcell"><%= v11 %></td>
                <td class="tcell"><%= t15 %></td>
                <td class="vcell"><%= v15 %></td>
              </tr>
              <tr>
                <td class="tcell"><%= t4 %></td>
                <td class="vcell"><%= v4 %></td>
                <td class="tcell"><%= t8 %></td>
                <td class="vcell"><%= v8 %></td>
                <td class="tcell"><%= t12 %></td>
                <td class="vcell"><%= v12 %></td>
                <td class="tcell"><%= t16 %></td>
                <td class="vcell"><%= v16 %></td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </script>

    <!-- scripts for inserting a Bootstrap tab and tab content-->
    <script id="bs_tab-pane" type="text/template">
      <div class="tab-pane" id="<%= tab_content_id %>">
        <iframe class="gps_result" id="<%= iframe_id %>" width="<%= iframe_width %>" height="<%= iframe_height %>" allowfullscreen="true" sandbox="allow-same-origin allow-top-navigation allow-forms allow-scripts">
        </iframe>
      </div>
    </script>

    <script id="bs_nav-tab" type="text/template">
      <li>
        <a id="<%= tab_id %>" href="#<%= tab_content_id %>" data-toggle="tab">
          <span><%= tab_name %></span>
          <div class="tb">
            <button class="close close-tab" type="button" onclick="deleteTab(event)">&times;</button>
          </div>
        </a>
      </li>
    </script>

    <!-- script for adding the Map and Favorites buttons to patent tabs -->
    <script id="tab-buttons" type="text/template">
       <div class="tb tb-left">
          <span class="hide-result-btn btn-map-add" title="Add to patent map"></span>
          <span class="hide-result-btn btn-favorite-add" title="Add to favorites"></span>
       </div>
    </script>

    <!--    <script type="text/javascript" charset="utf-8">
      $.get("http://www.google.com/advanced_patent_search",
            function(data) {
              alert('Got: ' + data);
            }
      );
    </script>   -->
    <script type="text/javascript" charset="utf-8">
      var w = 960, h = 500;
      var margin_bot = 30;
      var startDate = new Date("01-01-1972");
      var endDate = new Date();
      var labelDistance = 0;

      var vis = d3.select("#Map").append("svg:svg").attr("width", w).attr("height", h); // create SVG container element to contain the graphics
      // define the scale: domain is plot coordinates; range is screen coordinates
      var xAxisScale = d3.time.scale().domain([startDate, endDate]).range([0, w]);
      var xAxisLabel = d3.svg.axis().orient("bottom").ticks(d3.time.year,5).tickPadding(4).tickSize(2).scale(xAxisScale);  // create the x-axis with labels only
      var xAxisLabelSVG = vis.append("g").attr("class","x-axis-label").attr("transform", "translate(0," + (h-margin_bot).toString() +")")
                          .call(xAxisLabel);                                             // create x axis label SVG elements and call xAxisLabel function
      d3.selectAll("g.x-axis-label > g.tick > line").remove();                           // remove tick
      var xAxisGrid = d3.svg.axis().orient("top").ticks(d3.time.year,1).tickPadding(0).tickSize(h-margin_bot).scale(xAxisScale);  // create the x-axis gridlines
      var xAxisGridSVG = vis.append("g").attr("class","x-axis-grid").attr("transform", "translate(0," + (h-margin_bot).toString() +")")
                          .style("stroke","lightgray").style("fill","transparent").call(xAxisGrid);   // x axis gridline SVG; override default stroke:white, fill:black
      d3.selectAll("g.x-axis-grid > g.tick > text").remove();                            // remove text

      var nodes = [];
      var labelAnchors = [];
      var labelAnchorLinks = [];
      var links = [];

      for(var i = 0; i < 30; i++) {                  // nodes to be plotted in force diagram
        var x_Date = new Date(startDate)
        x_Date.setFullYear(x_Date.getFullYear() + 10*Math.floor(5*Math.random())) 
        var node = {
          x_fix : xAxisScale(x_Date),  // a fixed time axis random values of decade since startDate
          label : "node " + i
        };
        nodes.push(node);                // list of nodes
        labelAnchors.push({              // labelAnchors[2*i].node = nodes[i].node; define the force node associated with the force2 nodes
          node : node
        });
        labelAnchors.push({              // labelAnchors[2*i + 1].node = nodes[i].node
          node : node
        });
      };

      for(var i = 0; i < nodes.length; i++) {
        for(var j = 0; j < i; j++) {
          if(Math.random() > .95) links.push({source : i, target : j, weight : Math.random()}); // randomly assign links (edges) between nodes
        }                                                                                       // with .source, .target, and .weight properties
        labelAnchorLinks.push({source : i * 2, target : i * 2 + 1, weight : 1});  // i.e., the source and target for labelAnchorLink are the same node
      };

      var force = d3.layout.force().size([w, h-margin_bot]).nodes(nodes).links(links).gravity(1).linkDistance(50).charge(-20000).linkStrength(function(x) {
                         return x.weight * .01});            // define the force map for the nodes, specifying the nodes, links, and linkStrengths
      force.start();

      var force2 = d3.layout.force().nodes(labelAnchors).links(labelAnchorLinks).gravity(1).linkDistance(0).linkStrength(8).charge(-100).size([w, h]);
      force2.start();                                        // define the force directed map for the node labels

      var link = vis.selectAll("line.link").data(links).enter().append("svg:line").attr("class", "link").style("stroke", "tomato");  // add the links to the SVG

      var node = vis.selectAll("g.node").data(force.nodes()).enter().append("svg:g").attr("class", "node");                        // add the nodes to the SVG
      node.append("svg:circle").attr("r", 5).style("fill", "#555").style("stroke", "#FFF").style("stroke-width", 3);               // make each node a circle
      node.call(force.drag);

//    Since we do not want to float the labels away from the nodes, we do not need a separate force layout for the labels.
//    Just add the svg:text elements directly to the nodes
//      var anchorLink = vis.selectAll("line.anchorLink").data(labelAnchorLinks)                                              // add the labelAnchorLinks to the SVG
//                 //.enter().append("svg:line").attr("class", "anchorLink").style("stroke", "#999");                         // but do not need to add lines as normally would
//      var anchorNode = vis.selectAll("g.anchorNode").data(force2.nodes()).enter().append("svg:g").attr("class", "anchorNode");     // add the labelAnchor nodes to the SVG
//      anchorNode.append("svg:circle").attr("r", 0).style("fill", "#FFF");                                // add the labelAnchor nodes to the SVG; circle radius is zero
//      anchorNode.append("svg:text").text(function(d, i) {return i % 2 == 0 ? "" : d.node.label})         // add the node labels to the SVG
//                                   .style("fill", "#555").style("font-family", "Arial").style("font-size", 12);
      node.append("svg:text").text(function(d, i) {return d.label})         // add the node labels to the SVG
              .attr("text-anchor","middle").attr("dominant-baseline","middle").style("fill", "#555").style("font-family", "Arial").style("font-size", 12);


      var updateLink = function() {                                    // move a link to its new position
        this.attr("x1", function(d) {return d.source.x;})
                  .attr("y1", function(d) {return d.source.y;})
                  .attr("x2", function(d) {return d.target.x;})
		  .attr("y2", function(d) {return d.target.y;});
      }

      var updateNode = function() {                                    // move a node to its new position
        this.attr("transform", function(d) {return "translate(" + d.x + "," + d.y + ")";});
      }

      force.on("tick", function(e) {
        force2.start();

//        node.call(updateNode);
//        console.log("e.alpha: " + e.alpha);
        node.each(function(d, i) {
          d.x = d.px + 0.1*(d.x - d.px);
          d.y = d.py + 0.1*(d.y - d.py);
          d.x = d.x + ((Math.log(10*0.099) - Math.log(10*e.alpha))/(Math.log(10*0.099) - Math.log(10*0.005)))*(d.x_fix - d.x);
                                                        // default value of alpha starts at 0.1 and decays exponentially to 0.005
        });
        node.attr("transform", function(d) {return "translate(" + d.x + "," + d.y + ")";}); // exactly the updateNode function (??)
/* 
        anchorNode.each(function(d, i) {
                 	    if(i % 2 == 0) {
                              d.x = d.node.x;         // .node is the 'node' property set in lines 29, 32, i.e. the 'force' node associated with this 'force2' label node
                              d.y = d.node.y;
                            } else {
                              var b = this.childNodes[1].getBBox();  // note in Firefox getBBox throws an exception if the element is not 'visible'
                              var diffX = d.x - d.node.x;            // (fix is to have the page be off screen)
                              var diffY = d.y - d.node.y;
                              var dist = Math.sqrt(diffX * diffX + diffY * diffY);

                              var shiftX = b.width * (diffX - dist) / (dist * 2);
                              shiftX = Math.max(-b.width, Math.min(0, shiftX));
                              var shiftX = 0, shiftY = 0;
                              // shiftY = 5;
                              this.childNodes[1].setAttribute("transform", "translate(" + shiftX + "," + shiftY + ")");
                            }
                        });

*/
//        anchorNode.call(updateNode);

        link.call(updateLink);
//        anchorLink.call(updateLink);
      });
    </script>
  </body>
</html>
