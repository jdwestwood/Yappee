// create a new patent tab or go to an existing one; process the patent page once its loaded

      function patentTab(patent_url, patentLabel, on_patent_tab_complete) {
      // check if a tab for patentLabel exists; if not, query Google at patent_url and create it; call optional callback
      // on_patent_tab_complete when done
        var $aTab = $("a[data-tabname='" + patentLabel + "']");    // check if patent tab for this patent already exists
        if ($aTab.length == 0) {
          make_patent_tab(patent_url, patentLabel);
        }
        else {
          $aTab.click();
          if (on_patent_tab_complete) {
            var patent_no = $aTab.attr("data-patent");
            on_patent_tab_complete(patent_no);
          }
        }

        function make_patent_tab(patent_url, patentLabel) {
        // add HTML for the new patent tab and label it with patentLabel; set up the iframe and load it with the Google
        // patent document at patent_url.
          nPatentTabs += 1;
          var tab_id = "patTab_" + nPatentTabs;
          var tab_content_id = "patent_" + nPatentTabs;
          var iframe_id = "gps_patent_" + nPatentTabs;
          var navTabHTML = _.template( $("script#bs_nav-tab").html(),
                                       {tab_id: tab_id, tab_content_id: tab_content_id, tab_name: patentLabel});
          var tabContentHTML = _.template( $("script#bs_tab-pane").html(),
            {tab_content_id: tab_content_id, iframe_id: iframe_id, iframe_width: 1050, iframe_height: googleIFrameHeight});
          var tabButtonHTML = $("script#tab-buttons").html();
          $("div.tab-pane.active").after(tabContentHTML);
          $("ul#topTabs li.active").after(navTabHTML);
          var aTab = $("a#" + tab_id);
          aTab.append(tabButtonHTML);                          // add the map and favorite buttons
          var $iframe = $("iframe#" + iframe_id)
          $iframe.css("visibility", "hidden")
                 .on("load", on_patent_load)
                 .on("error", on_patent_load_error);
          $.cookie("yappee_cl", clientCookie);
          $("iframe#" + iframe_id).attr("src", patent_url);

          function on_patent_load_error(event) {
          // error handler if iframe does not load due to bad Google patent link
            $.removeCookie("yappee_cl");
            debug("In on_patent_load_error, error event is ", event);
          }

          function on_patent_load() {
          // modify the HTML
            var $context = $(this).contents();
            $("head", $context).append($("script#search-term-table-style").html());    // append style for replacement page header
            $("div#pocs", $context).remove();                  // 4/2/2014 div#pocs does not seem to exist any more
            process_links($context, "patent");
            process_patent_button_bar($context);
            $("a[href='/patents']", $context).remove();        // link to basic patent search
            $("div#footer_table", $context).remove();          // links at the bottom of the page
            $("body *", $context).each(deleteTopContent);      // delete undesired top content
            $("body", $context).prepend($("script#page-header").html());  // replace with my own
            $("div.viewport-chrome-toolbar div:contains('Application')", $context)
              .each( function(index) {$(this).on("click", {index: index}, on_click_Application);} );  // Application button(s)
            $("div.viewport-chrome-toolbar div:contains('Grant')", $context)
              .each( function(index) {$(this).on("click", {index: index}, on_click_Grant);} );        // Grant button
            $("span.notice-section > a", $context)             // Override default event handler assigned in process_links
              .off("click", on_click_new_patent_url).on("click", on_click_AlsoPublishedAs);
            $("td.patent-bibdata-heading:contains('Also published as') ~ td span.patent-bibdata-value > a", $context)
              .off("click", on_click_new_patent_url).on("click", on_click_AlsoPublishedAs);
            $("tr.patent-internal-links", $context).on("click", on_click_patent_internal_links);
            // set up the popover for the patent tab; parse the doc to get the full patent_no.
            var patent_no = tabPopoverManager.setupPatentTab(tab_id, $context);
            $.removeCookie("yappee_cl");
            $("a#" + tab_id).tab("show");
            window.scrollTo(0,0);
            window.focus();
            window.setTimeout(function() {$iframe.css("visibility", "visible");}, 1000);
            if (on_patent_tab_complete) {
              on_patent_tab_complete(patent_no);                                      // callback with the full patent_no
            }

            function deleteTopContent() {
            // .each jQuery function to process the top content of the patent page; 'this' is each child of the body element;
            // return false halts the .each function calls
              var $elem = $(this);
              switch ($elem.prop("tagName")) {
                case "TABLE":
                  return false;                                 // stop iterating through the children of the body element
                  break;
                case "SCRIPT":
                  return;
                default:
                  if (!$elem.hasClass("kd-appbar")) {           // remove everything except the div.kd-appbar element
                    $elem.remove();
                  }
              }
            }

            function on_click_Application(event) {
            // do not call event.stopPropagation() so Google's update code will run; a new on_patent_load event will be
            // triggered when the iframe load with new data.
              $.cookie("yappee_cl", clientCookie);
              var $context = $(this.ownerDocument);
              var thisIndex = event.data.index;                       // index of element the triggered the event
              var application_url = $("a[data-label='Application']", $context).eq(thisIndex).attr("href");
              var link_match = rExp_patno_from_url.exec(application_url);
              var application_no = link_match ? link_match[1] : '';
              $("ul#topTabs li.active > a > span").text(application_no);     // note we are not changing the id of the tab
              window.scrollTo(0,0);
            }

            function on_click_Grant(event) {
            // do not call event.stopPropagation() so Google's update code will run; a new on_patent_load event will be
            // triggered when the iframe load with new data.
              $.cookie("yappee_cl", clientCookie);
              var $context = $(this.ownerDocument);
              var thisIndex = event.data.index;
              var grant_url = $("a[data-label='Grant']", $context).eq(thisIndex).attr("href");
              var link_match = rExp_patno_from_url.exec(grant_url);
              var grant_no = link_match ? link_match[1] : '';
              $("ul#topTabs li.active > a > span").text(grant_no);     // note we are not changing the id of the tab
              window.scrollTo(0,0);
            }
          }
        }

        function on_click_patent_internal_links(event) {
        // click event handler for links to lists references on a patent page; main page scrolls down and hides the tabs at
        // the top of the page; this function scrolls the main page back up to the top so tabs are visible.
          var $target = $(event.target);
          if ($target.prop("tagName") == "A") {
            window.setTimeout(function() {window.scrollTo(0,0);}, 30)
          }
        }

        function on_click_AlsoPublishedAs(event) {
          var $context = $(this.ownerDocument.body);
          var grant_url = $(this).attr("href");
          var link_match = rExp_patno_from_url.exec(grant_url);
          var grant_no = link_match ? link_match[1] : '';
          // if patent will not open in separate browser tab, change the caption of the current application tab
          if (!external_URLs.some( function(external_URL) {return grant_url.search(external_URL) >= 0 ? true : false;})) {  
            $("ul#topTabs li.active > a > span").text(grant_no);
          }
          window.scrollTo(0,0);
        }
      }
